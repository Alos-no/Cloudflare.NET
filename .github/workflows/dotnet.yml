name: .NET Build and Test

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      # Restore dependencies for the entire solution.
      run: dotnet restore Cloudflare.NET.sln

    - name: Build solution
      # Build the entire solution to ensure all projects compile.
      run: dotnet build Cloudflare.NET.sln --no-restore

    - name: Run All Tests on Main/Develop Branch (Unit and Integration)
      # Runs the full test suite, including live integration tests.
      # This step REQUIRES the secrets to be configured in the repository.
      if: github.ref_name == 'main' || github.ref_name == 'develop'
      run: dotnet test Cloudflare.NET.sln --no-build --verbosity normal
      env:
        # These secrets must be configured in the GitHub repository settings.
        # The double underscore `__` is the standard convention for mapping
        # environment variables to nested JSON configuration keys.
        Cloudflare__ApiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        Cloudflare__AccountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        Cloudflare__ZoneId: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        Cloudflare__BaseDomain: ${{ secrets.CLOUDFLARE_BASE_DOMAIN }}
        R2__AccessKeyId: ${{ secrets.R2_ACCESS_KEY_ID }}
        R2__SecretAccessKey: ${{ secrets.R2_SECRET_ACCESS_KEY }}